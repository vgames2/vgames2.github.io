const supabaseUrl='https://utcvznvrbcifwnzkugvk.supabase.co',supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0Y3Z6bnZyYmNpZnduemt1Z3ZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM4MjUwNTksImV4cCI6MjA1OTQwMTA1OX0.3r20xIqTED7yoPBm_wIm7zZppzc2yBskLkBQRCT7JEE',supabase=supabase.createClient(supabaseUrl,supabaseKey),form=document.getElementById('create-account-form'),usernameInput=document.getElementById('username'),emailInput=document.getElementById('email'),passwordInput=document.getElementById('password'),confirmPasswordInput=document.getElementById('confirm-password'),submitBtn=document.getElementById('submit-btn'),buttonText=document.getElementById('button-text'),spinner=document.getElementById('spinner'),errorMessage=document.getElementById('error-message'),statusMessage=document.getElementById('status-message'),usernameRegex=/^@(?!.*example)[a-zA-Z0-9_]*\d+$/;form.addEventListener('submit',async e=>{e.preventDefault(),showLoading(!0),clearMessages();try{const e=usernameInput.value.trim(),t=emailInput.value.trim(),n=passwordInput.value;if(!validateInputs(e,n))return showLoading(!1),!1;if(!await isUsernameAvailable(e))return showError('Error 10: Username already exists'),showLoading(!1),!1;const o={username:e,email:t,createdAt:new Date().toISOString(),status:'active'},a=`${e}.json`;if(!await uploadAccountFile(a,o))return showError('Error 12: Failed to create account file'),showLoading(!1),!1;if(!await createDatabaseRecord(e,t,n,a))return showError('Error 22: Failed to create database record'),await supabase.storage.from('vgstcl').remove([`accounts/${a}`]),showLoading(!1),!1;showStatus('Account created successfully! Redirecting...','success'),setTimeout(()=>{window.location.href='https://login.vgames.run.place'},2e3)}catch(e){console.error('Account creation error:',e),showError('An unexpected error occurred. Please try again.'),showLoading(!1)}});function validateInputs(e,t){return!!usernameRegex.test(e)||(showError('Username must start with @, contain no "example", and end with a number'),!1)&&(t===confirmPasswordInput.value||(showError('Passwords do not match'),!1)&&(t.length>=8||(showError('Password must be at least 8 characters'),!1)}async function isUsernameAvailable(e){const{data:t}=await supabase.from('accounts').select('username').eq('username',e).single(),{data:n}=await supabase.storage.from('vgstcl').list('accounts',{search:`${e}.json`});return!t&&(!n||0===n.length)}async function uploadAccountFile(e,t){const{error:n}=await supabase.storage.from('vgstcl').upload(`accounts/${e}`,JSON.stringify(t),{contentType:'application/json',upsert:!1});return!n}async function createDatabaseRecord(e,t,n,o){const{error:a}=await supabase.from('accounts').insert([{username:e,email:t,password_hash:n,file_path:`accounts/${o}`,created_at:new Date().toISOString()}]);return!a}function showLoading(e){e?(buttonText.textContent='Creating Account...',spinner.classList.remove('hidden'),submitBtn.disabled=!0):(buttonText.textContent='Create Account',spinner.classList.add('hidden'),submitBtn.disabled=!1)}function showError(e){errorMessage.textContent=e,errorMessage.style.display='block',errorMessage.style.animation='shake 0.5s ease-in-out'}function showStatus(e,t){statusMessage.textContent=e,statusMessage.style.display='block',statusMessage.className=`status-message ${t}`}function clearMessages(){errorMessage.style.display='none',statusMessage.style.display='none'}usernameInput.addEventListener('input',debounce(async function(){const e=this.value.trim();if(e&&!usernameRegex.test(e))return void showError('Invalid username format');const t=await isUsernameAvailable(e);t?clearMessages():showError('Username already taken')},500));function debounce(e,t){let n;return function(){const o=this,a=arguments;clearTimeout(n),n=setTimeout(()=>e.apply(o,a),t)}}const style=document.createElement('style');style.textContent='@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-5px)}40%,80%{transform:translateX(5px)}}.status-message.success{color:#2ecc71}.status-message.error{color:#e74c3c}',document.head.appendChild(style);
